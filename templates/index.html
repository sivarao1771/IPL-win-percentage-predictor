<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPL Win Probability Predictor - Fabulous 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            overflow: hidden;
        }
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .perspective-container {
            perspective: 1000px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        .glass-card {
            background: rgba(10, 10, 10, 0.5);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: transform 0.1s ease-out;
            transform-style: preserve-3d;
            width: 95%;
            max-width: 500px;
        }
        .progress-bar-container {
            background-color: rgba(17, 24, 39, 0.7);
        }
        .progress-bar {
            transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1);
        }
        select, input[type="number"] {
            background-color: rgba(31, 41, 55, 0.8);
            border-color: rgba(75, 85, 99, 0.8);
            transition: all 0.3s ease;
        }
        select:focus, input[type="number"]:focus {
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5);
            border-color: #22c55e;
        }
        .btn-predict {
            background: linear-gradient(45deg, #10b981, #22c55e, #84cc16);
            background-size: 200% auto;
            transition: background-position 0.5s ease, transform 0.2s ease;
        }
        .btn-predict:hover {
            background-position: right center;
            transform: scale(1.05);
        }
        .glow-text {
            text-shadow: 0 0 8px rgba(134, 239, 172, 0.5), 0 0 20px rgba(74, 222, 128, 0.3);
        }
        select.placeholder {
            color: #9ca3af;
        }
        select:not(.placeholder) {
            color: white;
        }
        .model-breakdown {
            font-size: 0.8rem;
            color: #9ca3af;
        }
    </style>
</head>
<body class="text-white">
    <canvas id="bg-canvas"></canvas>

    <div class="perspective-container">
        <div class="glass-card rounded-2xl p-6 md:p-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center mb-2 glow-text">IPL Win Predictor</h1>
            <p class="text-center text-gray-400 mb-8">Powered by an Ensemble of Machine Learning Models</p>

            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <select id="batting-team" class="w-full p-2.5 rounded-md focus:outline-none placeholder"></select>
                    <select id="bowling-team" class="w-full p-2.5 rounded-md focus:outline-none placeholder"></select>
                    <select id="city" class="col-span-1 md:col-span-2 w-full p-2.5 rounded-md focus:outline-none placeholder"></select>
                    <input type="number" id="target" placeholder="Target Score" class="w-full p-2.5 rounded-md text-white focus:outline-none">
                    <input type="number" id="score" placeholder="Current Score" class="w-full p-2.5 rounded-md text-white focus:outline-none">
                    <input type="number" id="overs" placeholder="Overs Completed" class="w-full p-2.5 rounded-md text-white focus:outline-none">
                    <input type="number" id="wickets" placeholder="Wickets Down" class="w-full p-2.5 rounded-md text-white focus:outline-none">
                </div>
                <button id="predict-btn" class="btn-predict w-full text-white font-bold py-3 px-8 rounded-lg shadow-lg">
                    Calculate Probability
                </button>
            </div>

            <div id="result-container" class="hidden mt-8">
                <h3 class="text-lg font-bold text-center mb-2">Final Prediction (Weighted Average)</h3>
                <div class="flex justify-between items-center mb-2 text-md font-medium">
                    <span id="batting-team-label" class="team-label">Batting Team</span>
                    <span id="bowling-team-label" class="team-label">Bowling Team</span>
                </div>
                <div class="progress-bar-container w-full h-8 rounded-full overflow-hidden flex border border-gray-600">
                    <div id="batting-progress" class="progress-bar flex items-center justify-end pr-3">
                        <span id="batting-prob" class="font-bold text-sm"></span>
                    </div>
                    <div id="bowling-progress" class="progress-bar flex items-center justify-start pl-3">
                        <span id="bowling-prob" class="font-bold text-sm"></span>
                    </div>
                </div>
                <div id="error-message" class="text-center text-red-400 mt-4 font-medium"></div>

                <div class="mt-6 model-breakdown text-center space-y-1">
                    <h4 class="font-semibold text-gray-300 mb-2">Individual Model Predictions:</h4>
                    <p>Random Forest (45% weight): <span id="rf-prob" class="font-bold text-white"></span></p>
                    <p>ANN (45% weight): <span id="ann-prob" class="font-bold text-white"></span></p>
                    <p>Logistic Regression (10% weight): <span id="lr-prob" class="font-bold text-white"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 3D Background Setup ---
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            const geometry = new THREE.SphereGeometry(1.5, 32, 32);
            const material = new THREE.MeshStandardMaterial({ color: 0xB22222, roughness: 0.4, metalness: 0.2 });
            const ball = new THREE.Mesh(geometry, material);
            scene.add(ball);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 1);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);
            
            const pointLight2 = new THREE.PointLight(0x22c55e, 0.7);
            pointLight2.position.set(-5, -5, 2);
            scene.add(pointLight2);

            const starGeometry = new THREE.BufferGeometry();
            const starVertices = [];
            for (let i = 0; i < 10000; i++) {
                const x = (Math.random() - 0.5) * 2000;
                const y = (Math.random() - 0.5) * 2000;
                const z = (Math.random() - 0.5) * 2000;
                if(Math.sqrt(x*x + y*y + z*z) > 100) starVertices.push(x, y, z);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const starMaterial = new THREE.PointsMaterial({ color: 0x888888, size: 0.7 });
            const stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);

            camera.position.z = 5;

            function animate() {
                requestAnimationFrame(animate);
                ball.rotation.x += 0.001;
                ball.rotation.y += 0.005;
                stars.rotation.y += 0.0002;
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // --- Interactive 3D Card ---
            const card = document.querySelector('.glass-card');
            const perspectiveContainer = document.querySelector('.perspective-container');
            perspectiveContainer.addEventListener('mousemove', (e) => {
                const rect = perspectiveContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const rotateX = (y - centerY) / 50;
                const rotateY = (centerX - x) / 50;
                card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });
            perspectiveContainer.addEventListener('mouseleave', () => {
                card.style.transform = 'rotateX(0) rotateY(0)';
            });

            // --- UI and Prediction Logic ---
            const teams = ['Sunrisers Hyderabad', 'Mumbai Indians', 'Royal Challengers Bengaluru', 'Kolkata Knight Riders', 'Punjab Kings', 'Chennai Super Kings', 'Rajasthan Royals', 'Delhi Capitals', 'Lucknow Super Giants', 'Gujarat Titans'];
            const cities = ['Ahmedabad', 'Bangalore', 'Bengaluru', 'Bloemfontein', 'Cape Town', 'Centurion', 'Chandigarh', 'Chennai', 'Cuttack', 'Delhi', 'Dharamsala', 'Durban', 'East London', 'Hyderabad', 'Indore', 'Jaipur', 'Johannesburg', 'Kimberley', 'Kolkata', 'Lucknow', 'Mohali', 'Mumbai', 'Nagpur', 'Port Elizabeth', 'Pune', 'Raipur', 'Ranchi', 'Sharjah', 'Visakhapatnam'];
            
            const teamData = {
                'Sunrisers Hyderabad': { color: '#FF822A' },
                'Mumbai Indians': { color: '#004B8D' },
                'Royal Challengers Bengaluru': { color: '#D41C24' },
                'Kolkata Knight Riders': { color: '#3A225D' },
                'Punjab Kings': { color: '#DD1F2D' },
                'Chennai Super Kings': { color: '#FDB913' },
                'Rajasthan Royals': { color: '#004C93' },
                'Delhi Capitals': { color: '#00008B' },
                'Lucknow Super Giants': { color: '#00AEEF' },
                'Gujarat Titans': { color: '#1B2133' },
            };

            const battingTeamSelect = document.getElementById('batting-team');
            const bowlingTeamSelect = document.getElementById('bowling-team');
            const citySelect = document.getElementById('city');

            const handlePlaceholder = (selectElement) => {
                if (selectElement.value === "") {
                    selectElement.classList.add('placeholder');
                } else {
                    selectElement.classList.remove('placeholder');
                }
            };

            battingTeamSelect.innerHTML = '<option value="" disabled selected>Select Batting Team</option>';
            bowlingTeamSelect.innerHTML = '<option value="" disabled selected>Select Bowling Team</option>';
            citySelect.innerHTML = '<option value="" disabled selected>Select City / Venue</option>';

            teams.forEach(team => {
                battingTeamSelect.innerHTML += `<option value="${team}">${team}</option>`;
                bowlingTeamSelect.innerHTML += `<option value="${team}">${team}</option>`;
            });

            cities.sort().forEach(city => {
                citySelect.innerHTML += `<option value="${city}">${city}</option>`;
            });

            [battingTeamSelect, bowlingTeamSelect, citySelect].forEach(sel => {
                sel.addEventListener('change', () => handlePlaceholder(sel));
            });

            const predictBtn = document.getElementById('predict-btn');
            const resultContainer = document.getElementById('result-container');
            const errorMessage = document.getElementById('error-message');

            predictBtn.addEventListener('click', async () => {
                const battingTeam = battingTeamSelect.value;
                const bowlingTeam = bowlingTeamSelect.value;
                const city = citySelect.value;
                const target = parseInt(document.getElementById('target').value) || 0;
                const score = parseInt(document.getElementById('score').value) || 0;
                const overs = parseFloat(document.getElementById('overs').value) || 0;
                const wickets = parseInt(document.getElementById('wickets').value) || 0;
                
                errorMessage.textContent = '';
                
                if (!battingTeam || !bowlingTeam || !city) {
                    errorMessage.textContent = 'Please select teams and a city.';
                    resultContainer.classList.add('hidden');
                    return;
                }

                resultContainer.classList.remove('hidden');

                if (battingTeam === bowlingTeam) {
                    errorMessage.textContent = 'Batting and Bowling teams cannot be the same.';
                    return;
                }
                if (overs < 0 || overs > 20 || wickets < 0 || wickets > 10 || score < 0 || target < 1) {
                    errorMessage.textContent = 'Please enter realistic match values.';
                    return;
                }
                 if (score >= target) {
                    errorMessage.textContent = 'Current score cannot be less than the target.';
                    return;
                }

                const runs_left = target - score;
                const balls_bowled = Math.floor(overs) * 6 + (overs % 1) * 10;
                const balls_left = 120 - balls_bowled;
                const wickets_left = 10 - wickets;
                const crr = balls_bowled === 0 ? 0 : (score * 6) / balls_bowled;
                const rrr = balls_left === 0 ? 999 : (runs_left * 6) / balls_left;

                if (balls_left <= 0 && runs_left > 0) {
                     displayResult(0, 0, 0, 0, battingTeam, bowlingTeam);
                     return;
                }
                if (runs_left <= 0) {
                    displayResult(1, 1, 1, 1, battingTeam, bowlingTeam);
                    return;
                }
                
                // --- FETCH PREDICTION FROM BACKEND ---
                try {
                    const response = await fetch('https://ipl-match-win-percentage-predictor.onrender.com/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            batting_team: battingTeam,
                            bowling_team: bowlingTeam,
                            city: city,
                            runs_left: runs_left,
                            balls_left: balls_left,
                            wickets_left: wickets_left,
                            runs_target: target,
                            crr: crr,
                            rrr: rrr
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    displayResult(
                        result.final_prediction,
                        result.model_breakdown.random_forest,
                        result.model_breakdown.ann,
                        result.model_breakdown.logistic_regression,
                        battingTeam,
                        bowlingTeam
                    );

                } catch (error) {
                    console.error("Fetch error:", error);
                    errorMessage.textContent = 'Could not connect to the prediction server. Is it running?';
                }
            });

            function displayResult(final, rf, ann, lr, battingTeam, bowlingTeam) {
                 const finalBattingProb = Math.round(final * 100);
                 const finalBowlingProb = 100 - finalBattingProb;
                 
                 document.getElementById('batting-team-label').textContent = battingTeam;
                 document.getElementById('bowling-team-label').textContent = bowlingTeam;
                 
                 const battingProgress = document.getElementById('batting-progress');
                 const bowlingProgress = document.getElementById('bowling-progress');
                 battingProgress.style.width = `${finalBattingProb}%`;
                 bowlingProgress.style.width = `${finalBowlingProb}%`;
                 battingProgress.style.backgroundColor = teamData[battingTeam].color;
                 bowlingProgress.style.backgroundColor = teamData[bowlingTeam].color;

                 document.getElementById('batting-prob').textContent = `${finalBattingProb}%`;
                 document.getElementById('bowling-prob').textContent = `${finalBowlingProb}%`;

                 // Display individual model results
                 document.getElementById('rf-prob').textContent = `${(rf * 100).toFixed(2)}%`;
                 document.getElementById('ann-prob').textContent = `${(ann * 100).toFixed(2)}%`;
                 document.getElementById('lr-prob').textContent = `${(lr * 100).toFixed(2)}%`;
            }
        });
    </script>
</body>
</html>
